<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Planning - OrganMatch AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Bricolage Grotesque', sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }

        /* Header */
        .header {
            background: #1e4d2b;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background: #e74c3c;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            font-size: 1.5em;
            font-weight: 700;
            color: white;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .page-title {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e4d2b;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        /* Transport Grid */
        .transport-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .transport-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #transport-map {
            height: 100%;
            width: 100%;
        }

        /* Flight List */
        .flight-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flight-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flight-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .flight-item.selected {
            border-left-color: #28a745;
            background: #e8f5e8;
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .flight-number {
            font-weight: 700;
            color: #1e4d2b;
            font-size: 1.1em;
        }

        .flight-cost {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            color: #6c757d;
            font-size: 0.9em;
        }

        /* Weather Panel */
        .weather-panel {
            grid-column: 1 / -1;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .weather-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .weather-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .weather-location {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .weather-condition {
            color: #6c757d;
            font-size: 0.9em;
        }

        .weather-detail {
            color: #6c757d;
            font-size: 0.8em;
            margin-top: 2px;
        }

        /* Action Buttons */
        .action-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 0 10px;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .btn-primary {
            background: #1e4d2b;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5a35;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .transport-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #007bff;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e4d2b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Decision Panel Styles */
        .decision-input-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .summary-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .ai-decision-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .decision-header {
            margin-bottom: 15px;
        }

        .decision-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.6;
        }

        .decision-recommendation {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }

        .decision-recommendation.proceed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .decision-recommendation.caution {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .decision-recommendation.abort {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .decision-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .decision-factors {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .decision-factors h5 {
            margin-bottom: 10px;
            color: #495057;
        }

        .decision-factors ul {
            margin: 0;
            padding-left: 20px;
        }

        .decision-factors li {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .risk-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-level.low {
            background: #d4edda;
            color: #155724;
        }

        .risk-level.medium {
            background: #fff3cd;
            color: #856404;
        }

        .risk-level.high {
            background: #f8d7da;
            color: #721c24;
        }

        /* OrganMatch AI Decision Styles */
        .ai-decision-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        /* Main Recommendation Card - OrganMatch Theme */
        .recommendation-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #1e4d2b;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .recommendation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(30, 77, 43, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .recommendation-card:hover::before {
            left: 100%;
        }

        .recommendation-card.proceed {
            border-color: #28a745;
            background: #f8fff8;
        }

        .recommendation-card.caution {
            border-color: #e74c3c;
            background: #fff8f8;
        }

        .recommendation-card.abort {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .recommendation-icon-large {
            font-size: 3.5em;
            color: #1e4d2b;
        }

        .recommendation-card.proceed .recommendation-icon-large {
            color: #28a745;
        }

        .recommendation-card.caution .recommendation-icon-large {
            color: #e74c3c;
        }

        .recommendation-card.abort .recommendation-icon-large {
            color: #dc3545;
        }

        .recommendation-details {
            flex: 1;
        }

        .recommendation-title {
            font-size: 1.6em;
            font-weight: 700;
            margin: 0 0 15px 0;
            color: #1e4d2b;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .confidence-display {
            margin-top: 20px;
        }

        .confidence-label {
            font-size: 0.9em;
            color: #2d5a35;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .confidence-meter {
            position: relative;
        }

        .confidence-track {
            height: 10px;
            background: #e8e8e8;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .confidence-fill.excellent {
            background: #28a745;
        }

        .confidence-fill.good {
            background: #1e4d2b;
        }

        .confidence-fill.fair {
            background: #e74c3c;
        }

        .confidence-fill.low {
            background: #dc3545;
        }

        .confidence-text {
            font-size: 0.8em;
            font-weight: 700;
            color: white;
        }

        /* Analysis Grid - OrganMatch Style */
        .decision-analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .analysis-panel, .risk-panel {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #1e4d2b;
            transition: all 0.3s ease;
            position: relative;
        }

        .analysis-panel::before, .risk-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(30, 77, 43, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .analysis-panel:hover::before, .risk-panel:hover::before {
            left: 100%;
        }

        .analysis-panel:hover, .risk-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: #2d5a35;
        }

        /* Panel Headers - OrganMatch Style */
        .panel-header {
            background: #1e4d2b;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            background: #e74c3c;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }

        .risk-icon {
            background: #e74c3c;
        }

        .panel-title {
            flex: 1;
        }

        .panel-title h4 {
            margin: 0 0 5px 0;
            color: white;
            font-size: 1.3em;
            font-weight: 700;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .analysis-source {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .analysis-source.rule_based {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .risk-badge.low {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .risk-badge.medium {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .risk-badge.high {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Panel Content - OrganMatch Style */
        .panel-content {
            padding: 25px;
            text-align: left;
        }

        .analysis-text {
            line-height: 1.6;
            font-family: 'Bricolage Grotesque', sans-serif;
            text-align: left;
        }

        .analysis-subsection {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fff8;
            border-radius: 10px;
            border-left: 4px solid #1e4d2b;
            text-align: left;
        }

        .subsection-header {
            font-size: 1em;
            font-weight: 700;
            color: #1e4d2b;
            margin: 0 0 10px 0;
            font-family: 'Bricolage Grotesque', sans-serif;
            text-align: left;
        }

        .subsection-content {
            text-align: left;
        }

        .subsection-content p {
            margin: 8px 0;
            color: #2d5a35;
            font-size: 0.95em;
            line-height: 1.5;
            text-align: left;
        }

        .analysis-paragraph {
            text-align: left;
        }

        .analysis-paragraph p {
            margin: 12px 0;
            color: #2d5a35;
            font-size: 0.95em;
            line-height: 1.6;
            text-align: left;
        }

        .risk-factors {
            margin-top: 10px;
        }

        .factors-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .factor-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: #f8fff8;
            border-radius: 8px;
            border-left: 3px solid #28a745;
            transition: all 0.3s ease;
            text-align: left;
        }

        .factor-item:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .factor-item i {
            font-size: 1.1em;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .factor-item .text-success {
            color: #28a745 !important;
        }

        .factor-item .text-warning {
            color: #e74c3c !important;
        }

        .factor-item .text-danger {
            color: #dc3545 !important;
        }

        .factor-item span {
            font-size: 0.9em;
            line-height: 1.5;
            color: #1e4d2b;
            font-family: 'Bricolage Grotesque', sans-serif;
            text-align: left;
        }

        .factor-item span strong {
            font-weight: 700;
            color: #1e4d2b;
        }

        .no-factors {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* Decision Summary - OrganMatch Style */
        .decision-summary {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #1e4d2b;
            position: relative;
        }

        .decision-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(30, 77, 43, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .decision-summary:hover::before {
            left: 100%;
        }

        .summary-header {
            background: #1e4d2b;
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .summary-header i {
            font-size: 1.3em;
        }

        .summary-header h4 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 700;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .summary-content {
            padding: 25px;
        }

        .summary-grid {
            display: grid;
            gap: 20px;
        }

        .summary-item {
            padding: 20px;
            background: #f8fff8;
            border-radius: 10px;
            border-left: 4px solid #1e4d2b;
        }

        .summary-label {
            font-size: 0.85em;
            font-weight: 700;
            color: #2d5a35;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .summary-value {
            font-size: 1em;
            color: #1e4d2b;
            line-height: 1.5;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .summary-value.proceed {
            color: #28a745;
            font-weight: 600;
        }

        .summary-value.caution {
            color: #e74c3c;
            font-weight: 600;
        }

        .summary-value.abort {
            color: #dc3545;
            font-weight: 600;
        }

        .next-steps-list {
            margin: 10px 0 0 0;
            padding-left: 0;
            list-style: none;
        }

        .next-steps-list li {
            padding: 6px 0 6px 20px;
            position: relative;
            color: #2d5a35;
            font-size: 0.9em;
            font-family: 'Bricolage Grotesque', sans-serif;
        }

        .next-steps-list li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: #1e4d2b;
            font-weight: bold;
        }

        .timeline-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .timeline-item.completed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .timeline-item.current {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .timeline-item.pending {
            background: #f8f9fa;
            border-left: 4px solid #dee2e6;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .timeline-item.completed .timeline-dot {
            background: #28a745;
        }

        .timeline-item.current .timeline-dot {
            background: #ffc107;
        }

        .timeline-item.pending .timeline-dot {
            background: #dee2e6;
        }

        .timeline-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .timeline-content strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .timeline-content span {
            color: #6c757d;
            font-size: 0.9em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .decision-analysis-grid {
                grid-template-columns: 1fr;
            }

            .recommendation-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .recommendation-icon-large {
                font-size: 3em;
            }

            .recommendation-title {
                font-size: 1.5em;
            }

            .panel-header {
                padding: 15px 20px;
            }

            .panel-content {
                padding: 20px;
            }

            .summary-content {
                padding: 20px;
            }
        }

        /* Animation for loading states */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-decision-container {
            animation: fadeInUp 0.6s ease-out;
        }

        .recommendation-card {
            animation: fadeInUp 0.6s ease-out 0.1s both;
        }

        .analysis-panel {
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .risk-panel {
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .decision-summary {
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="9" y="2" width="6" height="20" fill="white" />
                    <rect x="2" y="9" width="20" height="6" fill="white" />
                </svg>
            </div>
            <div class="logo-text">OrganMatch</div>
        </div>
        <nav class="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/viability" class="nav-link">Viability</a>
            <a href="/matching" class="nav-link">Matching</a>
            <a href="/transport" class="nav-link active">Transport</a>

            <a href="/assistant" class="nav-link">Assistant</a>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="container">
        <h1 class="page-title">🚁 Transport Planning</h1>
        <p class="page-subtitle">Plan and coordinate organ transport between cities with real-time flight and weather data</p>

        <!-- Transport Grid -->
        <div class="transport-grid">
            <!-- Map Panel -->
            <div class="transport-card">
                <h3 class="card-title">
                    <i class="fas fa-map"></i>
                    Transport Route
                </h3>
                <div class="map-container">
                    <div id="transport-map"></div>
                </div>
                <div class="route-info" id="route-info">
                    <p><strong>Route:</strong> <span id="route-text">Select origin and destination</span></p>
                    <p><strong>Distance:</strong> <span id="distance-text">--</span></p>
                    <p><strong>Est. Time:</strong> <span id="time-text">--</span></p>
                </div>
            </div>

            <!-- Flight Options -->
            <div class="transport-card">
                <h3 class="card-title">
                    <i class="fas fa-plane"></i>
                    Available Flights
                </h3>
                <div class="flight-list" id="flight-list">
                    <!-- Flights will be populated here -->
                </div>
            </div>

            <!-- Weather Conditions -->
            <div class="transport-card weather-panel">
                <h3 class="card-title">
                    <i class="fas fa-cloud-sun"></i>
                    Weather Conditions
                </h3>
                <div class="weather-grid" id="weather-grid">
                    <!-- Weather will be populated here -->
                </div>
            </div>
        </div>

        <!-- AI Agent Decision Panel -->
        <div class="action-panel" id="agent-decision-panel">
            <h3><i class="fas fa-robot"></i> AI Transport Decision</h3>
            <p style="margin: 15px 0; color: #6c757d;">Let AI analyze all factors and recommend the best course of action</p>
            
            <div class="decision-input-summary" id="decision-summary" style="display: none;">
                <h4>Analysis Input:</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>Organ:</strong> <span id="summary-organ">-</span>
                    </div>
                    <div class="summary-item">
                        <strong>Viability:</strong> <span id="summary-viability">-</span>
                    </div>
                    <div class="summary-item">
                        <strong>Weather Origin:</strong> <span id="summary-weather-origin">-</span>
                    </div>
                    <div class="summary-item">
                        <strong>Weather Destination:</strong> <span id="summary-weather-dest">-</span>
                    </div>
                    <div class="summary-item">
                        <strong>Selected Flight:</strong> <span id="summary-flight">-</span>
                    </div>
                    <div class="summary-item">
                        <strong>Urgency:</strong> <span id="summary-urgency">-</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="getAIDecision()" id="ai-decision-btn">
                <i class="fas fa-brain"></i> Get AI Recommendation
            </button>
            
            <div class="ai-decision-result" id="ai-decision-result" style="display: none;">
                <div class="decision-header">
                    <h4><i class="fas fa-lightbulb"></i> AI Recommendation</h4>
                </div>
                <div class="decision-content" id="decision-content">
                    <!-- AI decision will be populated here -->
                </div>
                <div class="decision-actions" id="decision-actions" style="display: none;">
                    <button class="btn btn-success" onclick="proceedWithRecommendation()" id="proceed-btn">
                        <i class="fas fa-check"></i> Proceed as Recommended
                    </button>
                    <button class="btn btn-secondary" onclick="overrideDecision()" id="override-btn">
                        <i class="fas fa-exclamation-triangle"></i> Override Decision
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="action-panel">
            <h3>Manual Transport Actions</h3>
            <p style="margin: 15px 0; color: #6c757d;">Manual controls for transport arrangements</p>
            <button class="btn btn-primary" onclick="bookSelectedFlight()">
                <i class="fas fa-check"></i> Book Selected Flight
            </button>
            <button class="btn btn-success" onclick="notifyTeams()">
                <i class="fas fa-bell"></i> Notify Medical Teams
            </button>
            <button class="btn btn-secondary" onclick="generateReport()">
                <i class="fas fa-file-alt"></i> Generate Transport Report
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let selectedFlight = null;
        let organId = new URLSearchParams(window.location.search).get('organ');
        let transportData = null;
        let hospitals = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadTransportData();
            loadHospitals();
            
            if (organId) {
                loadOrganDetails(organId);
            }
        });

        // Initialize map
        function initializeMap() {
            map = L.map('transport-map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add sample route
            addSampleRoute();
        }

        function addSampleRoute() {
            // Default route if no transport data
            const defaultRoute = [
                { name: "Boston Medical", lat: 42.3601, lng: -71.0589 },
                { name: "UCLA Medical", lat: 34.0522, lng: -118.2437 }
            ];

            defaultRoute.forEach(hospital => {
                L.marker([hospital.lat, hospital.lng])
                    .addTo(map)
                    .bindPopup(hospital.name);
            });

            // Flight route
            const route = [[42.3601, -71.0589], [34.0522, -118.2437]];
            L.polyline(route, {
                color: '#007bff',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Update route info
            document.getElementById('route-text').textContent = 'Boston → Los Angeles';
            document.getElementById('distance-text').textContent = '2,600 miles';
            document.getElementById('time-text').textContent = '6.5 hours';
        }

        // Load transport data from viability page
        function loadTransportData() {
            const storedData = sessionStorage.getItem('transportData');
            if (storedData) {
                transportData = JSON.parse(storedData);
                updatePageWithTransportData();
                loadFlightsForRoute();
                loadWeatherForRoute();
            } else {
                // Load default data
                loadFlights();
                loadWeather();
            }
        }

        // Update page with transport data from viability
        function updatePageWithTransportData() {
            if (!transportData) return;

            // Update page title
            document.querySelector('.page-title').innerHTML = 
                `🚁 Transport Planning - ${transportData.organType.toUpperCase()} (${transportData.donorId})`;
            
            document.querySelector('.page-subtitle').textContent = 
                `Urgent organ transport: ${transportData.origin.name} → ${transportData.destination.name}`;

            // Update map with actual locations
            updateMapWithLocations();
            
            // Update route info
            document.getElementById('route-text').textContent = 
                `${transportData.origin.name} → ${transportData.destination.name}`;
        }

        // Update map with actual transport locations
        function updateMapWithLocations() {
            if (!transportData) return;

            // Clear existing markers and routes
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Get coordinates for cities (simplified mapping)
            const cityCoords = {
                'Boston': [42.3601, -71.0589],
                'Los Angeles': [34.0522, -118.2437],
                'Rochester': [44.0121, -92.4802],
                'Baltimore': [39.2904, -76.6122],
                'Cleveland': [41.4993, -81.6944],
                'Chicago': [41.8781, -87.6298],
                'New York': [40.7128, -74.0060],
                'Miami': [25.7617, -80.1918],
                'Seattle': [47.6062, -122.3321],
                'Denver': [39.7392, -104.9903]
            };

            const originCoords = cityCoords[transportData.origin.city] || [42.3601, -71.0589];
            const destCoords = cityCoords[transportData.destination.city] || [34.0522, -118.2437];

            // Add markers
            L.marker(originCoords)
                .addTo(map)
                .bindPopup(`<b>Origin:</b><br>${transportData.origin.name}<br>Donor: ${transportData.donorId}<br>Organ: ${transportData.organType}`);
            
            L.marker(destCoords)
                .addTo(map)
                .bindPopup(`<b>Destination:</b><br>${transportData.destination.name}<br>Recipient: ${transportData.recipientId}<br>Urgency: ${transportData.urgency}`);

            // Add route line
            L.polyline([originCoords, destCoords], {
                color: '#007bff',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Fit map to show both locations
            const group = new L.featureGroup([
                L.marker(originCoords),
                L.marker(destCoords)
            ]);
            map.fitBounds(group.getBounds().pad(0.1));

            // Calculate and update distance/time
            const distance = calculateDistance(originCoords, destCoords);
            document.getElementById('distance-text').textContent = `${Math.round(distance)} miles`;
            document.getElementById('time-text').textContent = `${Math.round(distance / 500 * 60)} minutes`; // Rough flight time
        }

        // Calculate distance between two coordinates
        function calculateDistance(coord1, coord2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Load hospitals from DynamoDB
        async function loadHospitals() {
            try {
                const response = await fetch('/api/hospitals');
                hospitals = await response.json();
            } catch (error) {
                console.error('Error loading hospitals:', error);
                hospitals = []; // Fallback to empty array
            }
        }

        // Load flights for the specific route
        async function loadFlightsForRoute() {
            if (!transportData) {
                loadFlights();
                return;
            }

            try {
                const response = await fetch('/api/search-flights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin: transportData.origin.code,
                        destination: transportData.destination.code,
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                renderFlights(data.flights || [], true);

            } catch (error) {
                console.error('Error loading flights:', error);
                renderFlights([], true); // Show sample flights
            }
        }

        // Load flights (default)
        async function loadFlights() {
            try {
                const response = await fetch('/api/search-flights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin: 'BOS',
                        destination: 'LAX',
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                renderFlights(data.flights || []);

            } catch (error) {
                console.error('Error loading flights:', error);
                showNotification('Error loading flight data', 'error');
            }
        }

        function renderFlights(flights, isUrgent = false) {
            const container = document.getElementById('flight-list');
            container.innerHTML = '';

            // Generate flights based on transport data or use samples
            let flightsToShow = flights;
            
            if (flights.length === 0) {
                // Generate sample flights based on route
                const routeInfo = transportData ? 
                    `${transportData.origin.code} → ${transportData.destination.code}` : 
                    'BOS → LAX';
                
                flightsToShow = [
                    {
                        flight: 'AA1234',
                        departure: '14:30',
                        arrival: '18:45',
                        duration: '6h 15m',
                        aircraft: 'Boeing 737',
                        price: isUrgent ? '$2,400' : '$1,200',
                        route: routeInfo
                    },
                    {
                        flight: 'DL5678',
                        departure: '16:00',
                        arrival: '20:30',
                        duration: '6h 30m',
                        aircraft: 'Airbus A320',
                        price: isUrgent ? '$2,100' : '$1,050',
                        route: routeInfo
                    },
                    {
                        flight: 'UA9012',
                        departure: '18:15',
                        arrival: '22:45',
                        duration: '6h 30m',
                        aircraft: 'Boeing 757',
                        price: isUrgent ? '$2,700' : '$1,350',
                        route: routeInfo
                    }
                ];
            }



            flightsToShow.forEach((flight, index) => {
                const flightElement = document.createElement('div');
                flightElement.className = 'flight-item';
                if (isUrgent) {
                    flightElement.style.borderLeftColor = '#dc3545';
                }
                flightElement.onclick = () => selectFlight(flight, flightElement);
                
                flightElement.innerHTML = `
                    <div class="flight-header">
                        <div class="flight-number">${flight.flight}</div>
                        <div class="flight-cost">${flight.price || '$1,200'}</div>
                    </div>
                    <div class="flight-details">
                        <div><i class="fas fa-plane-departure"></i> ${flight.departure}</div>
                        <div><i class="fas fa-plane-arrival"></i> ${flight.arrival}</div>
                        <div><i class="fas fa-clock"></i> ${flight.duration}</div>
                        <div><i class="fas fa-plane"></i> ${flight.aircraft || 'Boeing 737'}</div>
                        ${flight.route ? `<div><i class="fas fa-route"></i> ${flight.route}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(flightElement);
            });
        }

        function selectFlight(flight, element) {
            // Remove previous selection
            document.querySelectorAll('.flight-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current flight
            element.classList.add('selected');
            selectedFlight = flight;
            
            showNotification(`Selected flight ${flight.flight}`, 'info');
        }

        // Load weather for specific route
        async function loadWeatherForRoute() {
            if (!transportData) {
                loadWeather();
                return;
            }

            try {
                // Show loading state
                const container = document.getElementById('weather-grid');
                container.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1/-1;"><div class="loading"></div><p>Loading weather data...</p></div>';

                // Load weather for origin and destination
                const [originWeather, destWeather] = await Promise.all([
                    fetch('/api/get-weather', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ location: transportData.origin.city })
                    }).then(r => r.json()),
                    fetch('/api/get-weather', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ location: transportData.destination.city })
                    }).then(r => r.json())
                ]);

                console.log('Origin weather:', originWeather);
                console.log('Destination weather:', destWeather);

                const weatherData = [
                    { 
                        location: `${transportData.origin.city} (Origin)`, 
                        condition: originWeather.condition || 'Clear', 
                        temperature: `${Math.round(originWeather.temperature || 22)}°C`, 
                        icon: originWeather.icon || getWeatherIcon(originWeather.condition || 'Clear'),
                        humidity: originWeather.humidity ? `${originWeather.humidity}%` : 'N/A',
                        wind: originWeather.wind_kph ? `${Math.round(originWeather.wind_kph)} km/h` : 'N/A'
                    },
                    { 
                        location: 'En Route', 
                        condition: 'Variable', 
                        temperature: `${Math.round((originWeather.temperature + destWeather.temperature) / 2 || 20)}°C`, 
                        icon: '🌤️',
                        humidity: 'Variable',
                        wind: 'Variable'
                    },
                    { 
                        location: `${transportData.destination.city} (Destination)`, 
                        condition: destWeather.condition || 'Clear', 
                        temperature: `${Math.round(destWeather.temperature || 25)}°C`, 
                        icon: destWeather.icon || getWeatherIcon(destWeather.condition || 'Clear'),
                        humidity: destWeather.humidity ? `${destWeather.humidity}%` : 'N/A',
                        wind: destWeather.wind_kph ? `${Math.round(destWeather.wind_kph)} km/h` : 'N/A'
                    }
                ];

                renderWeather(weatherData);
                
                // Store weather data for AI decision
                currentWeatherData = weatherData;

                // Show success notification if real data was loaded
                if (!originWeather.error && !destWeather.error) {
                    showNotification('Real-time weather data loaded', 'success');
                } else {
                    showNotification('Using simulated weather data', 'warning');
                }

            } catch (error) {
                console.error('Error loading weather:', error);
                loadWeather(); // Fallback to default weather
                showNotification('Error loading weather data', 'error');
            }
        }

        // Load default weather
        async function loadWeather() {
            const weatherData = [
                { location: 'Boston (Origin)', condition: 'Clear', temperature: '22°C', icon: '☀️' },
                { location: 'En Route', condition: 'Partly Cloudy', temperature: '18°C', icon: '⛅' },
                { location: 'Los Angeles (Destination)', condition: 'Clear', temperature: '25°C', icon: '☀️' }
            ];

            renderWeather(weatherData);
            
            // Store weather data for AI decision
            currentWeatherData = weatherData;
        }

        // Render weather data
        function renderWeather(weatherData) {
            const container = document.getElementById('weather-grid');
            container.innerHTML = '';

            weatherData.forEach(weather => {
                const weatherElement = document.createElement('div');
                weatherElement.className = 'weather-item';
                
                weatherElement.innerHTML = `
                    <div class="weather-icon">${weather.icon}</div>
                    <div class="weather-location">${weather.location}</div>
                    <div class="weather-condition">${weather.condition}</div>
                    <div class="weather-condition"><strong>${weather.temperature}</strong></div>
                    ${weather.humidity ? `<div class="weather-detail">💧 ${weather.humidity}</div>` : ''}
                    ${weather.wind ? `<div class="weather-detail">💨 ${weather.wind}</div>` : ''}
                `;
                
                container.appendChild(weatherElement);
            });
        }

        // Get weather icon based on condition
        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '☀️',
                'Sunny': '☀️',
                'Partly Cloudy': '⛅',
                'Cloudy': '☁️',
                'Overcast': '☁️',
                'Rain': '🌧️',
                'Snow': '❄️',
                'Thunderstorm': '⛈️',
                'Fog': '🌫️'
            };
            return icons[condition] || '☀️';
        }

        // Load organ details
        async function loadOrganDetails(organId) {
            try {
                const response = await fetch(`/api/organ/${organId}`);
                const organ = await response.json();
                
                // Update page title with organ info
                document.querySelector('.page-title').innerHTML = 
                    `🚁 Transport Planning - ${organ.type} ${organ.id}`;
                
            } catch (error) {
                console.error('Error loading organ details:', error);
            }
        }

        // Global variables for AI decision
        let currentWeatherData = null;
        let aiDecisionData = null;

        // AI Decision Functions
        async function getAIDecision() {
            if (!transportData || !selectedFlight) {
                showNotification('Please select a flight first', 'error');
                return;
            }

            // Show loading state
            const btn = document.getElementById('ai-decision-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Analyzing...';
            btn.disabled = true;

            // Prepare decision summary
            updateDecisionSummary();

            try {
                // Gather all data for AI analysis
                const analysisData = {
                    organ: {
                        type: transportData.organType,
                        donorId: transportData.donorId,
                        urgency: transportData.urgency
                    },
                    route: {
                        origin: transportData.origin,
                        destination: transportData.destination
                    },
                    flight: {
                        flightNumber: selectedFlight.flight,
                        departure: selectedFlight.departure,
                        arrival: selectedFlight.arrival,
                        duration: selectedFlight.duration,
                        aircraft: selectedFlight.aircraft
                    },
                    weather: currentWeatherData,
                    timestamp: new Date().toISOString()
                };

                // Call AI agent
                const response = await fetch('/api/agent-transport-decision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisData)
                });

                if (response.ok) {
                    const decision = await response.json();
                    displayAIDecision(decision);
                    showNotification('AI analysis complete', 'success');
                } else {
                    throw new Error(`API returned ${response.status}`);
                }

            } catch (error) {
                console.error('AI decision error:', error);
                // Show simulated decision if API fails
                displaySimulatedDecision();
                showNotification('Using simulated AI decision', 'warning');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function updateDecisionSummary() {
            document.getElementById('decision-summary').style.display = 'block';
            
            document.getElementById('summary-organ').textContent = 
                `${transportData.organType} (${transportData.donorId})`;
            
            // Use viability data from matching
            const viabilityText = transportData.viabilityData ? 
                `Score: ${transportData.viabilityData.conditionScore}/100` : 'Good';
            document.getElementById('summary-viability').textContent = viabilityText;
            
            document.getElementById('summary-weather-origin').textContent = 
                currentWeatherData ? `${currentWeatherData[0].condition}, ${currentWeatherData[0].temperature}` : 'Loading...';
            document.getElementById('summary-weather-dest').textContent = 
                currentWeatherData ? `${currentWeatherData[2].condition}, ${currentWeatherData[2].temperature}` : 'Loading...';
            document.getElementById('summary-flight').textContent = 
                `${selectedFlight.flight} (${selectedFlight.duration})`;
            document.getElementById('summary-urgency').textContent = 
                `${transportData.urgency} (${transportData.severity || 'Unknown'} severity)`;
        }

        function displayAIDecision(decision) {
            aiDecisionData = decision;
            
            const resultDiv = document.getElementById('ai-decision-result');
            const contentDiv = document.getElementById('decision-content');
            
            resultDiv.style.display = 'block';
            
            const recommendation = decision.recommendation || 'proceed';
            const confidence = decision.confidence || 85;
            const reasoning = decision.reasoning || 'Analysis complete';
            const riskLevel = decision.riskLevel || 'low';
            const factors = decision.factors || [];
            const source = decision.source || 'ai_agent';

            contentDiv.innerHTML = `
                <div class="ai-decision-container">
                    <!-- Main Recommendation Card -->
                    <div class="recommendation-card ${recommendation}">
                        <div class="recommendation-header">
                            <div class="recommendation-icon-large">
                                ${getRecommendationIcon(recommendation)}
                            </div>
                            <div class="recommendation-details">
                                <h3 class="recommendation-title">${getRecommendationText(recommendation)}</h3>
                                <div class="confidence-display">
                                    <div class="confidence-label">AI Confidence Level</div>
                                    <div class="confidence-meter">
                                        <div class="confidence-track">
                                            <div class="confidence-fill ${getConfidenceLevel(confidence)}" 
                                                 style="width: ${confidence}%">
                                                <span class="confidence-text">${confidence}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis and Risk Grid -->
                    <div class="decision-analysis-grid">
                        <!-- AI Analysis Panel -->
                        <div class="analysis-panel">
                            <div class="panel-header">
                                <div class="panel-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="panel-title">
                                    <h4>AI Analysis</h4>
                                    <span class="analysis-source ${source}">
                                        ${source === 'ai_agent' ? '🤖 AI Agent' : '⚙️ Rule Engine'}
                                    </span>
                                </div>
                            </div>
                            <div class="panel-content">
                                <div class="analysis-text">
                                    ${formatAnalysisText(reasoning)}
                                </div>
                            </div>
                        </div>

                        <!-- Risk Assessment Panel -->
                        <div class="risk-panel">
                            <div class="panel-header">
                                <div class="panel-icon risk-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="panel-title">
                                    <h4>Risk Assessment</h4>
                                    <span class="risk-badge ${riskLevel}">
                                        ${getRiskIcon(riskLevel)} ${riskLevel.toUpperCase()} RISK
                                    </span>
                                </div>
                            </div>
                            <div class="panel-content">
                                ${formatRiskFactors(factors, riskLevel)}
                            </div>
                        </div>
                    </div>

                    <!-- Decision Summary -->
                    <div class="decision-summary">
                        <div class="summary-header">
                            <i class="fas fa-clipboard-check"></i>
                            <h4>Decision Summary</h4>
                        </div>
                        <div class="summary-content">
                            ${generateDecisionSummary(decision, recommendation, confidence, riskLevel)}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('decision-actions').style.display = 'flex';
        }

        function getRecommendationIcon(recommendation) {
            switch (recommendation) {
                case 'proceed':
                    return '<i class="fas fa-check-circle"></i>';
                case 'caution':
                    return '<i class="fas fa-exclamation-triangle"></i>';
                case 'abort':
                    return '<i class="fas fa-times-circle"></i>';
                default:
                    return '<i class="fas fa-check-circle"></i>';
            }
        }

        function formatAnalysisText(reasoning) {
            // Clean and structure the AI reasoning text
            let text = reasoning.replace(/###|##|#/g, '').trim();
            
            // Split into sections
            const sections = text.split('\n\n').filter(s => s.trim());
            
            let formattedHtml = '';
            
            sections.forEach(section => {
                const lines = section.split('\n').filter(l => l.trim());
                
                if (lines.length === 0) return;
                
                // Check if this is a header section (contains colon and is short)
                if (lines[0].includes(':') && lines[0].length < 60) {
                    const header = lines[0].replace(':', '').trim();
                    const content = lines.slice(1);
                    
                    formattedHtml += `
                        <div class="analysis-subsection">
                            <div class="subsection-header">${formatTextWithBold(header)}</div>
                            <div class="subsection-content">
                                ${content.map(line => {
                                    // Format bullet points
                                    if (line.trim().startsWith('•') || line.trim().startsWith('-')) {
                                        return `<div style="margin: 4px 0; padding-left: 15px;">• ${formatTextWithBold(line.trim().substring(1).trim())}</div>`;
                                    }
                                    return `<p>${formatTextWithBold(line.trim())}</p>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Regular paragraph with bullet point formatting
                    const formattedLines = lines.map(line => {
                        if (line.trim().startsWith('•') || line.trim().startsWith('-')) {
                            return `<div style="margin: 6px 0; padding-left: 15px; color: #1e4d2b;">• ${formatTextWithBold(line.trim().substring(1).trim())}</div>`;
                        }
                        return `<p style="margin: 8px 0;">${formatTextWithBold(line.trim())}</p>`;
                    }).join('');
                    
                    formattedHtml += `
                        <div class="analysis-paragraph">
                            ${formattedLines}
                        </div>
                    `;
                }
            });
            
            return formattedHtml || `<p class="analysis-paragraph">${formatTextWithBold(text)}</p>`;
        }

        function formatTextWithBold(text) {
            // Convert **text** to <strong>text</strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function formatRiskFactors(factors, riskLevel) {
            if (!factors || factors.length === 0) {
                return '<p class="no-factors">No specific risk factors identified.</p>';
            }

            const riskIcons = {
                'low': 'fas fa-check-circle text-success',
                'medium': 'fas fa-exclamation-triangle text-warning', 
                'high': 'fas fa-times-circle text-danger'
            };

            return `
                <div class="factors-list">
                    ${factors.map(factor => `
                        <div class="factor-item">
                            <i class="${riskIcons[riskLevel] || riskIcons['low']}"></i>
                            <span>${formatTextWithBold(factor)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getConfidenceLevel(confidence) {
            if (confidence >= 90) return 'excellent';
            if (confidence >= 75) return 'good';
            if (confidence >= 60) return 'fair';
            return 'low';
        }

        function getRiskIcon(riskLevel) {
            switch (riskLevel) {
                case 'low': return '🟢';
                case 'medium': return '🟡';
                case 'high': return '🔴';
                default: return '🟢';
            }
        }

        function generateDecisionSummary(decision, recommendation, confidence, riskLevel) {
            const actionText = {
                'proceed': 'Transport is approved and ready to proceed',
                'caution': 'Transport approved with additional safety measures',
                'abort': 'Transport is not recommended at this time'
            };

            const nextSteps = {
                'proceed': [
                    'Book the selected flight immediately',
                    'Notify medical teams at both locations',
                    'Prepare organ for transport',
                    'Monitor weather conditions during flight'
                ],
                'caution': [
                    'Review additional safety protocols',
                    'Ensure backup transport options',
                    'Increase monitoring frequency',
                    'Prepare contingency plans'
                ],
                'abort': [
                    'Seek alternative transport methods',
                    'Wait for improved conditions',
                    'Consider ground transport options',
                    'Reassess in 30 minutes'
                ]
            };

            return `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Final Decision</div>
                        <div class="summary-value ${recommendation}">${actionText[recommendation]}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Next Steps</div>
                        <div class="summary-value">
                            <ul class="next-steps-list">
                                ${nextSteps[recommendation].map(step => `<li>${step}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function displaySimulatedDecision() {
            // Simulate AI decision based on available data
            const weatherRisk = assessWeatherRisk();
            const urgencyFactor = transportData.urgency === 'High' ? 'high' : 'medium';
            
            let recommendation = 'proceed';
            let riskLevel = 'low';
            let confidence = 90;
            let factors = [];

            // Simple decision logic
            if (weatherRisk === 'high') {
                recommendation = 'caution';
                riskLevel = 'medium';
                confidence = 70;
                factors.push('Weather conditions may affect flight safety');
            }

            if (transportData.urgency === 'High') {
                factors.push('High urgency case - time critical');
                confidence += 5;
            }

            factors.push('Flight duration within acceptable range');
            factors.push('Route is well-established for medical transport');

            const simulatedDecision = {
                recommendation: recommendation,
                confidence: confidence,
                reasoning: `Based on analysis of weather conditions, flight parameters, and organ urgency, the AI recommends to ${recommendation === 'proceed' ? 'proceed with' : 'exercise caution for'} this transport.`,
                riskLevel: riskLevel,
                factors: factors
            };

            displayAIDecision(simulatedDecision);
        }

        function assessWeatherRisk() {
            if (!currentWeatherData) return 'low';
            
            // Simple weather risk assessment
            for (let weather of currentWeatherData) {
                if (weather.condition.toLowerCase().includes('storm') || 
                    weather.condition.toLowerCase().includes('thunder')) {
                    return 'high';
                }
                if (weather.condition.toLowerCase().includes('rain') || 
                    weather.condition.toLowerCase().includes('snow')) {
                    return 'medium';
                }
            }
            return 'low';
        }

        function getRecommendationText(recommendation) {
            switch (recommendation) {
                case 'proceed':
                    return '✅ PROCEED WITH TRANSPORT';
                case 'caution':
                    return '⚠️ PROCEED WITH CAUTION';
                case 'abort':
                    return '❌ DO NOT PROCEED';
                default:
                    return '✅ PROCEED WITH TRANSPORT';
            }
        }

        function proceedWithRecommendation() {
            if (aiDecisionData && aiDecisionData.recommendation === 'proceed') {
                bookSelectedFlight();
                showNotification('Following AI recommendation: Proceeding with transport', 'success');
            } else if (aiDecisionData && aiDecisionData.recommendation === 'caution') {
                showNotification('AI recommends caution. Please review conditions carefully.', 'warning');
                // Could show additional safety checklist here
            } else {
                showNotification('AI recommends against transport. Consider alternatives.', 'error');
            }
        }

        function overrideDecision() {
            const confirmed = confirm('Are you sure you want to override the AI recommendation? This decision will be logged.');
            if (confirmed) {
                showNotification('AI recommendation overridden. Manual control activated.', 'warning');
                // Log the override decision
                console.log('AI decision overridden:', aiDecisionData);
            }
        }

        // Action functions
        function bookSelectedFlight() {
            if (!selectedFlight) {
                showNotification('Please select a flight first', 'error');
                return;
            }
            
            showNotification(`Booking flight ${selectedFlight.flight}...`, 'info');
            
            // Simulate booking
            setTimeout(() => {
                showNotification(`Flight ${selectedFlight.flight} booked successfully!`, 'success');
            }, 2000);
        }

        function notifyTeams() {
            showNotification('Medical teams notified of transport schedule', 'success');
        }

        function generateReport() {
            showNotification('Transport report generated and sent to stakeholders', 'success');
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>